<?xml version="1.0" encoding="utf-8" standalone="yes"?><?xml-stylesheet href="/feed_style.xsl" type="text/xsl"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:media="https://www.rssboard.org/media-rss">
  <channel>
    <title>Ansible on Acme of foolishness</title>
    <link>http://localhost:1313/tags/ansible/</link>
    <description>Recent content in Ansible on Acme of foolishness</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en</language>
    <copyright>Damilola</copyright>
    <lastBuildDate>Tue, 03 Dec 2024 15:38:25 +0100</lastBuildDate><atom:link href="http://localhost:1313/tags/ansible/index.xml" rel="self" type="application/rss+xml" /><icon>http://localhost:1313/logo.svg</icon>
    
    
    <item>
      <title>Automating Deployments with Terraform and Ansible</title>
      <link>http://localhost:1313/posts/deploy-destroy-repeat/</link>
      <pubDate>Tue, 03 Dec 2024 15:38:25 +0100</pubDate>
      
      <guid>http://localhost:1313/posts/deploy-destroy-repeat/</guid>
      <description><![CDATA[<p>It is week 2 of my devops project challenges and the challenge of the week was to automate the deployment and configuration of the <a href="/posts/compose-your-apps">previous</a> week&rsquo;s challenge. It feels like the next step in the DevOps process, you have been able to package your applications, but you still need to setup infrastructure and many times repeatedly, doing this manually is not only tedious and time consuming but can lead to inconsistencies in the running environments for your applications, more importantly, it doesn&rsquo;t scale.</p>
<p>In this week&rsquo;s challenge we would be using the popular <a href="https://aws.amazon.com/what-is/iac/">IaC</a> tool <a href="https://www.terraform.io/">Terraform</a> in conjunction with the popular automation and configuration management tool <a href="https://www.ansible.com/">Ansible</a> to create a automated deployment process for our applictions. The goal is to be able to provision, configure and run all the necessary infrastructure required and then also pull them down when necessary, all with one command.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>terraform apply -auto-approve
</span></span></code></pre></div><p>To achieve this, we are going to need to be familiar with a couple of tools which should be installed on our machine.</p>
<ul>
<li>Terraform: To automate infrastructure provisioning</li>
<li>Ansible: To automate the configuration of our infrastructure and manage our application</li>
<li>AWS CLI: Used for AWS get specific information on the state of our infrastructure</li>
<li>Bash scripting: To write custom logic during automation</li>
</ul>
<h2 id="application-overview">Application Overview</h2>
<p>To provide a recap of <a href="/posts/compose-your-apps">week one</a> challenge, we packaged our apps into docker containers, consisting of a frontend appliaction, backend application, a database and host of monitoring services, then put all these services behind a reverse proxy to route traffic to the appropriate target, so all our HTTP services are only exposed through the reverse proxy. This diagram shows the architecture of our app</p>
<p><img src="images/architecture.png" alt="architecure diagram"></p>
<p>The repo for this week&rsquo;s challenge can be found <a href="https://github.com/The-DevOps-Dojo/cv-challenge-o2">here</a>.</p>
<h2 id="terraform">Terraform</h2>
<p><a href="https://www.terraform.io/">Terraform</a> is an open-source Infrastructure as Code (IaC) tool that allows you to define, provision, and manage infrastructure resources across various cloud providers and on-premises environments using a high-level configuration language called HCL.
We would be using Terraform to create our EC2 instance and to trigger Ansible to begin configuring our provisioned instance.</p>
<p>But before that, we would need to build, tag and push the docker images for our frontend and backend application to a container registry so we can pull these easily. Fork the <a href="https://github.com/The-DevOps-Dojo/cv-challenge-o2">repo</a> and clone to your local machine, copy over the files from the previous week&rsquo;s challenge to our new repo run the following commands to build and push.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker login <span style="color:#75715e"># do this if you have not logged in</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker build -f Dockerfile.frontend .
</span></span><span style="display:flex;"><span>docker build -f Dockerfile.backend .
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker images <span style="color:#75715e"># note the image id for your frontend and backend images</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker tag &lt;IMAGE_ID&gt; &lt;DOCKERHUB_USERNAME&gt;/frontend:latest <span style="color:#75715e"># replace &lt;IMAGE_ID&gt; and &lt;DOCKERHUB_USERNAME&gt;</span>
</span></span><span style="display:flex;"><span>docker tag &lt;IMAGE_ID&gt; &lt;DOCKERHUB_USERNAME&gt;/backend:latest <span style="color:#75715e"># replace &lt;IMAGE_ID&gt; and &lt;DOCKERHUB_USERNAME&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker push &lt;DOCKERHUB_USERNAME&gt;/frontend:latest
</span></span><span style="display:flex;"><span>docker push &lt;DOCKERHUB_USERNAME&gt;/backend:latest
</span></span></code></pre></div><p>Now that we have pushed our image to dockerhub, we have to modify our <code>docker-compose.app.yml</code> to pull these images instead.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">frontend</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">&lt;DOCKERHUB_USERNAME&gt;/frontend:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">app_network</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">&lt;DOCKERHUB_USERNAME&gt;/backend:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">app_network</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ...</span>
</span></span></code></pre></div><p>This way, we only rely on the already built docker images, somewhat seperating our build and deploy stages. With these out of the way, we can start terraforming the chaos of infrastructure deployment.</p>
<p>We would proceed by writing HCL config files to define our infrastructure. Create a main.tf file and variables.tf file. Our main.tf file houses our infrastructue definitions and variables.tf contains our variables. We want to provision an EC2 instance with docker and docker-compose installed.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-hcl" data-lang="hcl"><span style="display:flex;"><span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;aws_instance&#34; &#34;web_server&#34;</span> {
</span></span><span style="display:flex;"><span>  ami                         <span style="color:#f92672">=</span> <span style="color:#66d9ef">var</span>.<span style="color:#66d9ef">ami</span>
</span></span><span style="display:flex;"><span>  instance_type               <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;t2.micro&#34;</span>
</span></span><span style="display:flex;"><span>  key_name                    <span style="color:#f92672">=</span> <span style="color:#66d9ef">var</span>.<span style="color:#66d9ef">key_name</span>
</span></span><span style="display:flex;"><span>  vpc_security_group_ids      <span style="color:#f92672">=</span> <span style="color:#66d9ef">var</span>.<span style="color:#66d9ef">security_group_ids</span>
</span></span><span style="display:flex;"><span>  associate_public_ip_address <span style="color:#f92672">=</span> var.eip <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>
</span></span><span style="display:flex;"><span>  user_data                   <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">&lt;&lt;-</span><span style="color:#66d9ef">EOF</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    #!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">curl</span> <span style="color:#960050;background-color:#1e0010">-</span><span style="color:#66d9ef">fsSL</span> <span style="color:#66d9ef">https</span><span style="color:#960050;background-color:#1e0010">://</span><span style="color:#66d9ef">get</span>.<span style="color:#66d9ef">docker</span>.<span style="color:#66d9ef">com</span> <span style="color:#960050;background-color:#1e0010">-</span><span style="color:#66d9ef">o</span> <span style="color:#66d9ef">get</span><span style="color:#960050;background-color:#1e0010">-</span><span style="color:#66d9ef">docker</span>.<span style="color:#66d9ef">sh</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">sudo</span> <span style="color:#66d9ef">sh</span> <span style="color:#66d9ef">get</span><span style="color:#960050;background-color:#1e0010">-</span><span style="color:#66d9ef">docker</span>.<span style="color:#66d9ef">sh</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">sudo</span> <span style="color:#66d9ef">usermod</span> <span style="color:#960050;background-color:#1e0010">-</span><span style="color:#66d9ef">aG</span> <span style="color:#66d9ef">docker</span> <span style="color:#66d9ef">ubuntu</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">newgrp</span> <span style="color:#66d9ef">docker</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">curl</span> <span style="color:#960050;background-color:#1e0010">-</span><span style="color:#66d9ef">SL</span> <span style="color:#66d9ef">https</span><span style="color:#960050;background-color:#1e0010">://</span><span style="color:#66d9ef">github</span>.<span style="color:#66d9ef">com</span><span style="color:#960050;background-color:#1e0010">/</span><span style="color:#66d9ef">docker</span><span style="color:#960050;background-color:#1e0010">/</span><span style="color:#66d9ef">compose</span><span style="color:#960050;background-color:#1e0010">/</span><span style="color:#66d9ef">releases</span><span style="color:#960050;background-color:#1e0010">/</span><span style="color:#66d9ef">download</span><span style="color:#960050;background-color:#1e0010">/</span><span style="color:#66d9ef">v2</span>.<span style="color:#ae81ff">30</span>.<span style="color:#ae81ff">3</span><span style="color:#960050;background-color:#1e0010">/</span><span style="color:#66d9ef">docker</span><span style="color:#960050;background-color:#1e0010">-</span><span style="color:#66d9ef">compose</span><span style="color:#960050;background-color:#1e0010">-</span><span style="color:#66d9ef">linux</span><span style="color:#960050;background-color:#1e0010">-</span><span style="color:#66d9ef">x86_64</span> <span style="color:#960050;background-color:#1e0010">-</span><span style="color:#66d9ef">o</span> <span style="color:#66d9ef">docker</span><span style="color:#960050;background-color:#1e0010">-</span><span style="color:#66d9ef">compose</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">sudo</span> <span style="color:#66d9ef">chmod</span> <span style="color:#960050;background-color:#1e0010">+</span><span style="color:#66d9ef">x</span> <span style="color:#66d9ef">docker</span><span style="color:#960050;background-color:#1e0010">-</span><span style="color:#66d9ef">compose</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">sudo</span> <span style="color:#66d9ef">mv</span> <span style="color:#66d9ef">docker</span><span style="color:#960050;background-color:#1e0010">-</span><span style="color:#66d9ef">compose</span> <span style="color:#960050;background-color:#1e0010">/</span><span style="color:#66d9ef">usr</span><span style="color:#960050;background-color:#1e0010">/</span><span style="color:#66d9ef">local</span><span style="color:#960050;background-color:#1e0010">/</span><span style="color:#66d9ef">bin</span><span style="color:#960050;background-color:#1e0010">/</span><span style="color:#66d9ef">docker</span><span style="color:#960050;background-color:#1e0010">-</span><span style="color:#66d9ef">compose</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  tags <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    Name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;web_server&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;aws_eip_association&#34; &#34;eip_assoc&#34;</span> {
</span></span><span style="display:flex;"><span>  count               <span style="color:#f92672">=</span> var.eip <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#960050;background-color:#1e0010">?</span> <span style="color:#ae81ff">0</span> <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  instance_id         <span style="color:#f92672">=</span> <span style="color:#66d9ef">aws_instance</span>.<span style="color:#66d9ef">web_server</span>.<span style="color:#66d9ef">id</span>
</span></span><span style="display:flex;"><span>  allow_reassociation <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  allocation_id       <span style="color:#f92672">=</span> <span style="color:#66d9ef">var</span>.<span style="color:#66d9ef">eip</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>in variables.tf</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-hcl" data-lang="hcl"><span style="display:flex;"><span><span style="color:#66d9ef">variable</span> <span style="color:#e6db74">&#34;security_group_ids&#34;</span> {
</span></span><span style="display:flex;"><span>  description <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;The AWS security group to apply.&#34;</span>
</span></span><span style="display:flex;"><span>  type        <span style="color:#f92672">=</span> <span style="color:#66d9ef">list</span>(<span style="color:#66d9ef">string</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">variable</span> <span style="color:#e6db74">&#34;ami&#34;</span> {
</span></span><span style="display:flex;"><span>  description <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;The AMI ID to use for the instance.&#34;</span>
</span></span><span style="display:flex;"><span>  type        <span style="color:#f92672">=</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>  default     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ami-0866a3c8686eaeeba&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">variable</span> <span style="color:#e6db74">&#34;key_name&#34;</span> {
</span></span><span style="display:flex;"><span>  description <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Key pair&#34;</span>
</span></span><span style="display:flex;"><span>  type        <span style="color:#f92672">=</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">variable</span> <span style="color:#e6db74">&#34;eip&#34;</span> {
</span></span><span style="display:flex;"><span>  description <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Optional Elastic IP address to associate with instance if present&#34;</span>
</span></span><span style="display:flex;"><span>  type        <span style="color:#f92672">=</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>  default     <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">variable</span> <span style="color:#e6db74">&#34;domain_name&#34;</span> {
</span></span><span style="display:flex;"><span>  description <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;The domain name to use for the application.&#34;</span>
</span></span><span style="display:flex;"><span>  type        <span style="color:#f92672">=</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We would use environment variables to set the values for these variables and to do that, values for these variables can be gotten from your AWS console e.g the AMI ID, key pair etc. Terraform requires the <code>TF_VAR_</code> prefix for each defined variable, we also need to set our AWS IAM credentials to use the AWS plugin for terraform. You could put all these variables in a <code>.env</code> file and source it in your current terminal session to make these variables reflect.</p>
<pre tabindex="0"><code>export AWS_ACCESS_KEY_ID=&#34;anaccesskey&#34;
export AWS_SECRET_ACCESS_KEY=&#34;asecretkey&#34;
export AWS_REGION=&#34;us-west-2&#34;
export TF_VAR_ami=&#34;ami-eba&#34;
export TF_VAR_security_group_ids=&#39;[&#34;sg-eba&#34;]&#39;
export TF_VAR_domain_name=&#34;mydomain.com&#34;
export TF_VAR_eip=&#34;eipalloc-xxxxx&#34; # optional to use elastic ip
</code></pre><p>The next step is to tell terraform to initialize our project by running the command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>terraform init
</span></span></code></pre></div><p>This command fetches all our plugins listed in the main.tf file. We can then run the plan command to understand how terraform is going to provision these resources</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>terraform plan
</span></span></code></pre></div><p>We will see a plan on what terraform will create and how it plans to do so. Now we can run our apply command to provision the resources.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>terraform apply
</span></span></code></pre></div><p>It would display a prompt asking if you want to proceed, type yes and watch magic happen. In few minutes, you should have your EC2 instance running, and you can SSH into it to confirm it is accessible. We shall the proceed to configuring our server to run our apps with ansible.</p>
<h2 id="ansible">Ansible</h2>
<p>We would use ansible to pull our docker images to our host platform which already has docker installed, copy over the necessary config files for our monitoring services and reverse proxy, generate free SSL certificates to enable HTTPS and start our containers.</p>
<p>First, we need to generate an inventory file to tell ansible about our remote hosts, i.e the EC2 instance, we need the IP address of this instance and we can get that by modifying our terraform config file to include this step after provisioning the instance.</p>
<p>In the main.tf file, add the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-hcl" data-lang="hcl"><span style="display:flex;"><span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;local_file&#34; &#34;ansible_inventory&#34;</span> {
</span></span><span style="display:flex;"><span>  content  <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">&lt;&lt;-</span><span style="color:#66d9ef">EOF</span>
</span></span><span style="display:flex;"><span>    [<span style="color:#66d9ef">web_servers</span>]
</span></span><span style="display:flex;"><span>    ${var.eip !<span style="color:#f92672">=</span> null ? aws_eip_association.eip_assoc.public_ip : aws_instance.web_server.public_ip} ansible_user<span style="color:#f92672">=</span>ubuntu ansible_ssh_private_key_file<span style="color:#f92672">=</span><span style="color:#66d9ef">devops_challenge</span>.<span style="color:#66d9ef">pem</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">EOF</span>
</span></span><span style="display:flex;"><span>  filename <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${path.module}/inventory.ini&#34;</span>
</span></span><span style="display:flex;"><span>  file_permission <span style="color:#f92672">=</span> <span style="color:#ae81ff">0644</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This would create local file on our host machine named <code>inventory.ini</code> which would contain the IP address of our newly created EC2 instance.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[web_servers]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">34.116.202.250 ansible_user</span><span style="color:#f92672">=</span><span style="color:#e6db74">ubuntu ansible_ssh_private_key_file=key_pair.pem</span>
</span></span></code></pre></div><p>Make sure you have the key pair used to launch the EC2 instance saved as this would be needed when ansible wants to connect to your servers.</p>
<p>Run the <code>terraform init</code> command again to fetch the <code>local</code> provider for the <code>local_file</code> resource and run the <code>terraform plan &amp;&amp; terraform apply</code> commands to see your new inventory file. This tells ansible what hosts are available to be configured.</p>
<p>Ansible uses playbooks which are just <code>yaml</code> files to define plays which contains tasks to be run on each hosts, we would define a playbook to configure our instances but first we need to ensure our instances are up and available before ansible can begin, this is where the <code>aws</code> CLI tool will be used to query for our instance state and wait till it is ready. Modify the <code>local_file</code> resource like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-hcl" data-lang="hcl"><span style="display:flex;"><span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;local_file&#34; &#34;ansible_inventory&#34;</span> {
</span></span><span style="display:flex;"><span>  content  <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">&lt;&lt;-</span><span style="color:#66d9ef">EOF</span>
</span></span><span style="display:flex;"><span>    [<span style="color:#66d9ef">web_servers</span>]
</span></span><span style="display:flex;"><span>    ${var.eip !<span style="color:#f92672">=</span> null ? aws_eip_association.eip_assoc.public_ip : aws_instance.web_server.public_ip} ansible_user<span style="color:#f92672">=</span>ubuntu ansible_ssh_private_key_file<span style="color:#f92672">=</span><span style="color:#66d9ef">devops_challenge</span>.<span style="color:#66d9ef">pem</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">EOF</span>
</span></span><span style="display:flex;"><span>  filename <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${path.module}/inventory.ini&#34;</span>
</span></span><span style="display:flex;"><span>  file_permission <span style="color:#f92672">=</span> <span style="color:#ae81ff">0644</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">provisioner</span> <span style="color:#e6db74">&#34;local-exec&#34;</span> {
</span></span><span style="display:flex;"><span>    command <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">&lt;&lt;-</span><span style="color:#66d9ef">EOF</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">aws</span> <span style="color:#66d9ef">ec2</span> <span style="color:#66d9ef">wait</span> <span style="color:#66d9ef">instance</span><span style="color:#960050;background-color:#1e0010">-</span><span style="color:#66d9ef">status</span><span style="color:#960050;background-color:#1e0010">-</span><span style="color:#66d9ef">ok</span> <span style="color:#960050;background-color:#1e0010">--</span><span style="color:#66d9ef">instance</span><span style="color:#960050;background-color:#1e0010">-</span><span style="color:#66d9ef">ids</span> <span style="color:#e6db74">${</span><span style="color:#960050;background-color:#1e0010">aws_instance</span>.<span style="color:#960050;background-color:#1e0010">web_server</span>.<span style="color:#960050;background-color:#1e0010">id</span><span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>      ansible-playbook -i inventory.ini -e &#34;APP_SERVER_NAME<span style="color:#f92672">=</span><span style="color:#e6db74">${</span><span style="color:#960050;background-color:#1e0010">var</span>.<span style="color:#960050;background-color:#1e0010">domain_name</span><span style="color:#e6db74">}</span><span style="color:#960050;background-color:#1e0010">&#34;</span> <span style="color:#66d9ef">ansible</span><span style="color:#960050;background-color:#1e0010">/</span><span style="color:#66d9ef">deploy</span>.<span style="color:#66d9ef">yml</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">EOF</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Create a new folder to house all our ansible related files and create a playbook called <code>deploy.yml</code>. We would be using ansible <a href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_reuse_roles.html">roles</a> to organize our ansible configuration and it requires a certain folder structure.</p>
<p>Create the following files</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir -p ansible/roles/web_servers/tasks
</span></span><span style="display:flex;"><span>mkdir ansible/roles/web_servers/files
</span></span><span style="display:flex;"><span>touch ansible/deploy.yml
</span></span><span style="display:flex;"><span>touch ansible/roles/web_servers/tasks/main.yml
</span></span></code></pre></div><p>We just created a <code>deploy</code> playbook and <code>web_server</code> roles, roles can contain a <code>tasks/</code> folder which defines the tasks the role would perform tasks in the <code>tasks/main.yml</code> play. The <code>files/</code> folder contains files needed for our roles to run, files like the docker-compose files, config files for prometheus, grafana etc and nginx configuration would need to be copied over to the remote host. We can mv those files over to the <code>files/</code> directory.</p>
<p>We begin with the <code>deploy</code> playbook which contains only one play:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>: <span style="color:#ae81ff">web_servers</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">become</span>: <span style="color:#66d9ef">yes</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">roles</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">web_servers</span>
</span></span></code></pre></div><p>The play targets the <code>web_servers</code> hosts that was defined in our inventory file and uses the <code>web_servers</code> role to run tasks on this target. The <code>roles/web_servers/tasks/main.yml</code> would then contain all our tasks for this play.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Ensure parent directory exist</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">file</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#34;/home/ubuntu/app&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">directory</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">mode</span>: <span style="color:#e6db74">&#34;0755&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Copy files</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">copy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">src</span>: <span style="color:#e6db74">&#34;{{ item.src }}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">dest</span>: <span style="color:#e6db74">&#34;/home/ubuntu/app/{{ item.dest }}&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">loop</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">src</span>: <span style="color:#e6db74">&#34;docker-compose.app.yml&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">dest</span>: <span style="color:#e6db74">&#34;docker-compose.app.yml&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">src</span>: <span style="color:#e6db74">&#34;docker-compose.monitoring.yml&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">dest</span>: <span style="color:#e6db74">&#34;docker-compose.monitoring.yml&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">src</span>: <span style="color:#e6db74">&#34;prometheus.yml&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">dest</span>: <span style="color:#e6db74">&#34;prometheus.yml&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">src</span>: <span style="color:#e6db74">&#34;loki-config.yml&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">dest</span>: <span style="color:#e6db74">&#34;loki-config.yml&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">src</span>: <span style="color:#e6db74">&#34;promtail-config.yml&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">dest</span>: <span style="color:#e6db74">&#34;promtail-config.yml&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">src</span>: <span style="color:#e6db74">&#34;grafana.ini&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">dest</span>: <span style="color:#e6db74">&#34;grafana.ini&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">src</span>: <span style="color:#e6db74">&#34;nginx&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">dest</span>: <span style="color:#e6db74">&#34;.&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Create .env for docker-compose to load</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">copy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">dest</span>: <span style="color:#e6db74">&#34;/home/ubuntu/app/.env&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">content</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      export COMPOSE_FILE=docker-compose.app.yml:docker-compose.monitoring.yml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      export APP_SERVER_NAME=&#34;{{ APP_SERVER_NAME }}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">mode</span>: <span style="color:#ae81ff">0644</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Request LetsEncrypt SSL Cert</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">script</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">cmd</span>: <span style="color:#e6db74">&#34;init-certbot.sh&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">become</span>: <span style="color:#66d9ef">yes</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">args</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">chdir</span>: <span style="color:#e6db74">&#34;/home/ubuntu/app&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Start Docker Containers</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">command</span>: <span style="color:#ae81ff">docker-compose up -d</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">become</span>: <span style="color:#66d9ef">yes</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">args</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">chdir</span>: <span style="color:#e6db74">&#34;/home/ubuntu/app&#34;</span>
</span></span></code></pre></div><p>The tasks are pretty straight forward, since we already have docker installed on this host in our provisioning phase, we don&rsquo;t need to install it with ansible. We create a folder to contain our files, copy over our files to this directory, pass the necessary environment variables, create SSL certificate for HTTPS and start our services. Easy peasy ðŸ˜‰.</p>
<p>I have written a <a href="https://github.com/0xdod/cv-challenge02/blob/main/ansible/roles/web_servers/files/init-certbot.sh">script</a> for the SSL certificate creation and also <a href="https://github.com/0xdod/cv-challenge02/tree/main/ansible/roles/web_servers/files/nginx">nginx configuration</a>. At this point, we are close to done. But before we proceed we need to instruct ansible of our roles and where to find them. In the root folder, create an <code>ansible.cfg</code> file with the following content</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cfg" data-lang="cfg"><span style="display:flex;"><span><span style="color:#66d9ef">[defaults]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">host_key_checking</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">False</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">roles_path</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">./ansible/roles</span>
</span></span></code></pre></div><p>This tells ansible about our roles and also for the sake of development, prevent strict host key checking which is a common issue when dealing with euphemeral hosts like cloud VMs.</p>
<p>We can proceed to run the command to provision and configure our resources</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>terraform apply -auto-approve
</span></span></code></pre></div><p>If this runs successfully, you should be able to access your app via the value of the <code>TF_VAR_domain_name</code> variable, this setup ensures that with one command we create an EC2 instance, install docker, copy over necessary configuration files, configure nginx as a reverse proxy, request SSL certificates for HTTPS and start our containers.</p>
<p>You can destroy the resources with also one command which terminates the EC2 instance and stops all services from running.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>terraform destroy -auto-approve
</span></span></code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>We have been able to see how terraform and ansible can work together to automate deployment processes, they can help speed up and streamline the process of deployments in the areas where they shine. Terraform is usually used to provision infrastructure and ansible to configure them. This gives us the ability to deploy infrastructure in an immutable fashion, multiple times a day in a reproducable and deterministic manner, we get to deploy, destroy and repeat!. The full solution to this challenge is contained in my <a href="https://github.com/0xdod/cv-challenge02">repo</a></p>
]]></description>
      
    </item>
    
    
  </channel>
</rss>
